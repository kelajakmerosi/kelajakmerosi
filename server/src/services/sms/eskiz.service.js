const ERROR_CODES = require('../../constants/errorCodes')

const ESKIZ_BASE_URL = (process.env.ESKIZ_BASE_URL || 'https://notify.eskiz.uz/api').replace(/\/$/, '')
const DEFAULT_OTP_TEMPLATE = 'KelajakMerosi tasdiqlash kodi: {code}. Kodni hech kimga bermang.'

let cachedToken = null
let cachedTokenExp = 0

const hasEskizConfig = () => Boolean(
  process.env.ESKIZ_EMAIL &&
  process.env.ESKIZ_PASSWORD &&
  process.env.ESKIZ_FROM
)

const getToken = async () => {
  if (process.env.ESKIZ_TOKEN) {
    return process.env.ESKIZ_TOKEN
  }

  if (!hasEskizConfig()) {
    const err = new Error('Eskiz credentials are not configured')
    err.errorCode = ERROR_CODES.SMS_PROVIDER_UNAVAILABLE
    err.status = 503
    throw err
  }

  const now = Date.now()
  if (cachedToken && cachedTokenExp > now + 30_000) return cachedToken

  const res = await fetch(`${ESKIZ_BASE_URL}/auth/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email: process.env.ESKIZ_EMAIL,
      password: process.env.ESKIZ_PASSWORD,
    }),
  })

  if (!res.ok) {
    const err = new Error('Eskiz auth failed')
    err.errorCode = ERROR_CODES.SMS_PROVIDER_UNAVAILABLE
    err.status = 503
    throw err
  }

  const payload = await res.json().catch(() => ({}))
  const token = payload?.data?.token
  if (!token) {
    const err = new Error('Eskiz token missing in response')
    err.errorCode = ERROR_CODES.SMS_PROVIDER_UNAVAILABLE
    err.status = 503
    throw err
  }

  cachedToken = token
  cachedTokenExp = now + 50 * 60 * 1000
  return token
}

const sendOtp = async (phone, code) => {
  const token = await getToken()
  const template = process.env.ESKIZ_OTP_TEXT_TEMPLATE || DEFAULT_OTP_TEMPLATE
  const message = template.includes('{code}')
    ? template.replace(/\{code\}/g, String(code))
    : `${template} ${code}`

  const form = new URLSearchParams()
  form.set('mobile_phone', phone.replace(/^\+/, ''))
  form.set('message', message)
  form.set('from', process.env.ESKIZ_FROM)
  if (process.env.ESKIZ_CALLBACK_URL) form.set('callback_url', process.env.ESKIZ_CALLBACK_URL)

  const res = await fetch(`${ESKIZ_BASE_URL}/message/sms/send`, {
    method: 'POST',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/x-www-form-urlencoded',
    },
    body: form,
  })

  if (!res.ok) {
    const text = await res.text().catch(() => '')
    let providerMessage = text
    try {
      const parsed = JSON.parse(text)
      providerMessage = parsed?.message || text
    } catch {
      // keep raw text
    }

    if (res.status === 400 && /модерац|moderat/i.test(providerMessage)) {
      const err = new Error('smsTemplateNotApproved')
      err.errorCode = ERROR_CODES.SMS_TEMPLATE_NOT_APPROVED
      err.status = 400
      throw err
    }

    const err = new Error('Eskiz SMS send failed')
    err.errorCode = ERROR_CODES.SMS_SEND_FAILED
    err.status = 502
    throw err
  }

  return true
}

module.exports = {
  getToken,
  sendOtp,
}
